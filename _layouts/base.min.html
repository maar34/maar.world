<!DOCTYPE html> {%- include snippets/get-lang.html -%} <html lang="{{ __return }}"> <head> {%- include analytics.html -%} {%- include head.html -%} <script> {%- include scripts/utils/utils.js -%}
      {%- include scripts/lib/throttle.js -%}
      {%- include scripts/lib/lazyload.js -%} </script> {%- include scripts/variables.html -%} {%- include scripts/cookie-consent.html -%} </head> <body> <div class="root" data-is-touch="false"> {{ content }} </div> <script> {%- include scripts/common.js -%}
      {%- include scripts/searchUsers.js -%} </script> <script>const API_BASE="http://media.maar.world:3001";async function checkSessionWithCache(){const o=localStorage.getItem("token"),e=localStorage.getItem("sessionData"),t=localStorage.getItem("sessionExpiry"),n=Date.now();if(e&&t&&n<parseInt(t,10))return console.log("Using cached session."),JSON.parse(e);if(!o)return redirectToLogin("No token found, redirecting to login."),null;try{const e=await fetch(`${API_BASE}/api/auth/check-session`,{method:"GET",headers:{Authorization:`Bearer ${o}`,"Content-Type":"application/json"}});if(!e.ok)return 429===e.status?(console.warn("429 Too Many Requests"),null):(redirectToLogin("Session validation failed, redirecting to login."),null);const{user:t,expiresIn:n}=await e.json();return t?(localStorage.setItem("sessionData",JSON.stringify(t)),localStorage.setItem("sessionExpiry",Date.now()+1e3*n),t):(redirectToLogin("No user data found, redirecting to login."),null)}catch(o){return console.error("Error checking session:",o),redirectToLogin("Error occurred during session validation, redirecting to login."),null}}function redirectToLogin(o){console.error(o),window.location.href="/login"}async function logoutUser(){const o=localStorage.getItem("token");if(!o)return console.error("No token found");try{if(!(await fetch(`${API_BASE}/api/auth/logout`,{method:"POST",headers:{Authorization:`Bearer ${o}`,"Content-Type":"application/json"}})).ok)throw new Error("Logout failed");localStorage.clear(),window.location.href="/login"}catch(o){console.error("Logout error:",o)}}function updateAuthLink(){const o=document.getElementById("auth-link");if(o){localStorage.getItem("token")?(o.innerHTML='<span class="material-symbols-outlined">logout</span> Logout',o.onclick=logoutUser):(o.innerHTML='<span class="material-symbols-outlined">login</span> Login',o.href="/login")}}document.addEventListener("DOMContentLoaded",(async function(){const o=await checkSessionWithCache();o&&(console.log("Session is valid:",o),localStorage.setItem("username",o.username||o.email),updateAuthLink())}))</script> 