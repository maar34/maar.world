---
layout: none
---

<!DOCTYPE html>
{%- include snippets/get-lang.html -%}
<html lang="{{ __return }}">
  <head>
    {%- include analytics.html -%}
    {%- include head.html -%}
    <script>
      {%- include scripts/utils/utils.js -%}
      {%- include scripts/lib/throttle.js -%}
      {%- include scripts/lib/lazyload.js -%}
    </script>
    {%- include scripts/variables.html -%}
    {%- include scripts/cookie-consent.html -%} <!-- Include the cookie consent code -->
  </head>
  <body>
    <div class="root" data-is-touch="false">
      {{ content }}
    </div>

    <!-- Include the common scripts -->
    <script>
      {%- include scripts/common.js -%}
    </script>

    <!-- Include the authentication script -->
    <script>
      {%- include scripts/auth.js -%}
      {%- include scripts/searchUsers.js -%}

    </script>

    <!-- Add script to check JWT token and session before rendering page -->
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM fully loaded and parsed');
    
        const authLink = document.getElementById('auth-link');
        const currentPage = window.location.pathname;
        const isPublicPage = {{ page.public | default: true }};  // Default to public unless specified otherwise
    
        // Function to handle logout
        async function logoutUser() {
          const token = localStorage.getItem('token');
          if (!token) {
            console.error('No token found for logout.');
            return;
          }
    
          try {
            const response = await fetch('http://media.maar.world:3001/api/auth/logout', {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json',
              },
            });
    
            if (!response.ok) {
              throw new Error('Failed to log out');
            }
    
            // Clear the token and redirect to login
            localStorage.removeItem('token');
            window.location.href = '/login';
          } catch (error) {
            console.error('Logout error:', error);
          }
        }
    
        // Check if a valid token exists
        function checkAuth() {
          const token = localStorage.getItem('token');
          if (token) {
            console.log('User is logged in, showing logout link');
            return true;
          }
          console.log('No valid token found');
          return false;
        }
    
        // Update the auth link (login or logout)
        function updateAuthLink() {
          const authLink = document.getElementById('auth-link');
          
          if (authLink) {
            if (checkAuth()) {
              authLink.innerHTML = '<span class="material-symbols-outlined">logout</span> Logout';
              authLink.href = 'javascript:void(0)'; // Keep the href for Logout as void
              authLink.onclick = function (event) {
                event.preventDefault();
                logoutUser();
              };
            } else {
              // Ensure the user is always directed to /login if not authenticated
              authLink.innerHTML = '<span class="material-symbols-outlined">login</span> Login';
              authLink.href = '/login'; // Set the correct login URL
              authLink.onclick = null;  // Clear any previous onclick events to avoid conflicts
            }
          }
        }
        
    
        // Function to handle session validation
        function checkUserSession() {
          const token = localStorage.getItem('token');
          console.log('Checking token in localStorage:', token);
    
          // If the page is private and no token is found, redirect to login
          if (!isPublicPage && !token) {
            console.log('No valid session, redirecting to login...');
            window.location.href = '/login';  // Redirect to login if no valid session
          }
        }
    
        // Initialize the page with session and auth link checks
        checkUserSession();  // Verify user session based on the page's access rule
        updateAuthLink();    // Update auth link on load
    
        // Handle storage changes (e.g., session updates in other tabs)
        window.addEventListener('storage', function () {
          console.log('Storage event detected, updating auth link');
          updateAuthLink();
        });
      });
    </script>
        
  </body>
</html>
