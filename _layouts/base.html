<!DOCTYPE html>
{%- include snippets/get-lang.html -%}
<html lang="{{ __return }}">
  <head>
    {%- include analytics.html -%}
    {%- include head.html -%}
    <script>
      {%- include scripts/utils/utils.js -%}
      {%- include scripts/lib/throttle.js -%}
      {%- include scripts/lib/lazyload.js -%}
    </script>
    {%- include scripts/variables.html -%}
    {%- include scripts/cookie-consent.html -%}
  </head>
  <body>
    <div class="root" data-is-touch="false">
      {{ content }}
    </div>

    <!-- Include common scripts -->
    <script>
      {%- include scripts/common.js -%}
    </script>
    
        <!-- Centralized Authentication and Session Management -->
        <script>
          const API_BASE = 'http://media.maar.world:3001';
    
          // Centralized session checking with caching and retry logic
          async function checkSessionWithCache() {
            const token = localStorage.getItem('token');
            const cachedSession = localStorage.getItem('sessionData');
            const sessionExpiry = localStorage.getItem('sessionExpiry');
            const currentTime = Date.now();
    
            // Use cached session if it's still valid
            if (cachedSession && sessionExpiry && currentTime < parseInt(sessionExpiry, 10)) {
              console.log('Using cached session.');
              return JSON.parse(cachedSession); // Return cached session data
            }
    
            // If no token, redirect to login
            if (!token) {
              redirectToLogin('No token found, redirecting to login.');
              return null;
            }
    
            try {
              const response = await fetch(`${API_BASE}/api/auth/check-session`, {
                method: 'GET',
                headers: {
                  'Authorization': `Bearer ${token}`,
                  'Content-Type': 'application/json'
                }
              });
    
              if (!response.ok) {
                if (response.status === 429) {
                  console.warn(`429 Too Many Requests`);
                  return null; // Skip retries to avoid overloading server
                }
                redirectToLogin('Session validation failed, redirecting to login.');
                return null;
              }
    
              const { user, expiresIn } = await response.json();
    
              if (!user) {
                redirectToLogin('No user data found, redirecting to login.');
                return null;
              }
    
              // Cache session data and set expiry time in localStorage
              localStorage.setItem('sessionData', JSON.stringify(user));
              localStorage.setItem('sessionExpiry', Date.now() + expiresIn * 1000); // Cache expiry time
    
              return user; // Return the session data
    
            } catch (error) {
              console.error('Error checking session:', error);
              redirectToLogin('Error occurred during session validation, redirecting to login.');
              return null;
            }
          }
    
          // Handle login redirection
          function redirectToLogin(message) {
            console.error(message);
            window.location.href = '/login';
          }
    
          // Call session check on DOM load
          document.addEventListener('DOMContentLoaded', async function() {
            const sessionData = await checkSessionWithCache();
    
            if (sessionData) {
              console.log('Session is valid:', sessionData);
              localStorage.setItem('username', sessionData.username || sessionData.email);
              // Update auth link or other elements on the page if necessary
              updateAuthLink();
            }
          });
    
          // Update login/logout link
          function updateAuthLink() {
            const authLink = document.getElementById('auth-link');
            if (authLink) {
              const token = localStorage.getItem('token');
              if (token) {
                authLink.innerHTML = '<span class="material-symbols-outlined">logout</span> Logout';
                authLink.onclick = logoutUser;
              } else {
                authLink.innerHTML = '<span class="material-symbols-outlined">login</span> Login';
                authLink.href = '/login';
              }
            }
          }
    
          // Logout function
          async function logoutUser() {
            const token = localStorage.getItem('token');
            if (!token) return console.error('No token found');
    
            try {
              const response = await fetch(`${API_BASE}/api/auth/logout`, {
                method: 'POST',
                headers: {
                  'Authorization': `Bearer ${token}`,
                  'Content-Type': 'application/json'
                }
              });
    
              if (!response.ok) throw new Error('Logout failed');
    
              localStorage.clear();
              window.location.href = '/login';
            } catch (error) {
              console.error('Logout error:', error);
            }
          }
    
        </script>
      </body>
    </html>
    