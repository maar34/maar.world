<!DOCTYPE html>
{%- include snippets/get-lang.html -%}
<html lang="{{ __return }}">
  <head>
    {%- include analytics.html -%}
    {%- include head.html -%}
    <script>
      {%- include scripts/utils/utils.js -%}
      {%- include scripts/lib/throttle.js -%}
      {%- include scripts/lib/lazyload.js -%}
    </script>
    {%- include scripts/variables.html -%}
    {%- include scripts/cookie-consent.html -%} <!-- Include the cookie consent code -->
  </head>
  <body>
    <div class="root" data-is-touch="false">
      {{ content }}
    </div>

    <!-- Include the common scripts -->
    <script>
      {%- include scripts/common.js -%}
    </script>

    <!-- Authentication Functions -->
    <script>
      // Function to handle user login with email/password via backend proxy
      async function loginUser(email, password) {
          try {
              const response = await fetch('http://media.maar.world:3001/api/auth/login', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ email, password })  // Send login details
              });
      
              if (!response.ok) throw new Error('Login failed');
      
              const data = await response.json();
              localStorage.setItem('token', data.token);
              localStorage.setItem('userId', data.user.id);
      
              // Redirect after successful login
              window.location.href = '/voyage';
          } catch (error) {
              console.error('Login error:', error);
              document.getElementById('message').innerText = "Login failed. Please try again.";
          }
      }
      
      // Function to handle sending password reset email
      async function forgotPassword(email) {
          try {
              const response = await fetch('http://media.maar.world:3001/api/auth/forgot-password', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ email })
              });
      
              if (!response.ok) throw new Error('Password reset failed');
      
              console.log('Password reset email sent to:', email);
          } catch (error) {
              console.error('Password reset error:', error);
          }
      }
      
      // Function to check if the user is logged in
      function checkAuth() {
          const token = localStorage.getItem('token');
          return !!token;
      }
      
      // Function to handle user logout
      async function logoutUser() {
          try {
              const token = localStorage.getItem('token');
              if (!token) return console.error('No token found');
      
              const response = await fetch('http://media.maar.world:3001/api/auth/logout', {
                  method: 'POST',
                  headers: {
                      'Authorization': `Bearer ${token}`,
                      'Content-Type': 'application/json',
                  },
              });
      
              if (!response.ok) throw new Error('Logout failed');
      
              // Clear token and user data from localStorage and redirect
              localStorage.clear();
              window.location.href = '/login';
          } catch (error) {
              console.error('Logout error:', error);
          }
      }
      
      // Manage session persistence
      function manageSessionPersistence() {
          const token = localStorage.getItem('token');
          if (token) console.log('Session will persist with token.');
          return token;
      }
      
      // Check for session and update auth link
      document.addEventListener('DOMContentLoaded', function() {
          const authLink = document.getElementById('auth-link');
          const isPublicPage = {{ page.public | default: true }};  // Default to public
      
          function updateAuthLink() {
              if (checkAuth()) {
                  authLink.innerHTML = '<span class="material-symbols-outlined">logout</span> Logout';
                  authLink.onclick = logoutUser;
              } else {
                  authLink.innerHTML = '<span class="material-symbols-outlined">login</span> Login';
                  authLink.href = '/login';
                  authLink.onclick = null;
              }
          }
      
          // Check session before rendering private pages
          function checkSession() {
            const token = localStorage.getItem('token');
            const isLoginPage = window.location.pathname === '/login';
            
            if (!isPublicPage && !token && !isLoginPage) {
                window.location.href = '/login';
            }
        }
      
          checkSession();  // Check session for private pages
          updateAuthLink();  // Update auth link on load
      
          // Update auth link on session change in other tabs
          window.addEventListener('storage', updateAuthLink);
      });
    </script>
  </body>
</html>
