let previousQuery="",isFetching=!1;function handleUserSearch(inputElement,resultsContainer){let timeout,selectedIndex=-1,previousQuery="";inputElement.addEventListener("input",(()=>{clearTimeout(timeout);const query=inputElement.value.trim();if(query===previousQuery||query.length<2)return resultsContainer.innerHTML="",selectedIndex=-1,void resultsContainer.classList.remove("active");previousQuery=query,timeout=setTimeout((async()=>{updateResultsDropdown(await searchUsers(query,false),resultsContainer,inputElement)}),500)})),inputElement.addEventListener("keydown",(event=>{const results=resultsContainer.querySelectorAll(".user-result");switch(event.key){case"ArrowDown":event.preventDefault(),selectedIndex<results.length-1&&(selectedIndex++,updateSelection(results,selectedIndex));break;case"ArrowUp":event.preventDefault(),selectedIndex>0&&(selectedIndex--,updateSelection(results,selectedIndex));break;case"Enter":event.preventDefault(),selectedIndex>=0&&results[selectedIndex]&&results[selectedIndex].click()}})),inputElement.addEventListener("blur",(async()=>{const inputValue=inputElement.value.trim();if(inputValue){await checkUsernameValidity(inputValue)||(inputElement.value="")}})),document.addEventListener("click",(event=>{inputElement.contains(event.target)||resultsContainer.contains(event.target)||resultsContainer.classList.remove("active")}))}async function searchUsers(query,isFetching){if(isFetching)return[];isFetching=!0;try{const response=await fetch(`http://media.maar.world:3001/api/searchUsers?query=${encodeURIComponent(query)}`);if(isFetching=!1,429===response.status)return console.warn("Too many requests. Please wait."),[];if(404===response.status)return console.warn("No users found for the query."),[];if(!response.ok)return console.warn(`Search request failed: ${response.status}`),[];return await response.json()||[]}catch(error){return console.error("Error during user search:",error),isFetching=!1,[]}}function updateResultsDropdown(users,container,inputElement){if(container.innerHTML="",0===users.length){const noResult=document.createElement("div");noResult.className="user-result",noResult.textContent="No users found. Invite them to join for better collaboration!",noResult.style.color="#d9534f",container.appendChild(noResult);const inviteButton=document.createElement("button");return inviteButton.className="invite-button",inviteButton.textContent="Register a new xPlorer",inviteButton.addEventListener("click",(()=>{window.location.href="/register"})),container.appendChild(inviteButton),void container.classList.add("active")}users.forEach((user=>{const item=document.createElement("div");item.className="user-result";const displayText=highlightMatch(`${user.displayName} (@${user.username})`,inputElement.value),text=document.createElement("span");text.innerHTML=displayText,item.appendChild(text),item.addEventListener("click",(()=>{inputElement.value=user.username,container.innerHTML="",container.classList.remove("active")})),container.appendChild(item)})),container.classList.add("active")}function updateSelection(results,selectedIndex){results.forEach(((result,index)=>{result.classList.toggle("selected",index===selectedIndex),index===selectedIndex&&result.scrollIntoView({block:"nearest"})}))}function highlightMatch(text,query){const regex=new RegExp(`(${query})`,"gi");return text.replace(regex,"<mark>$1</mark>")}async function checkUsernameValidity(username){try{const response=await fetch(`http://media.maar.world:3001/api/checkUsername?username=${encodeURIComponent(username)}`);if(429===response.status)return console.warn("Too many requests. Please wait."),!1;return!(await response.json()).isUnique}catch(error){return console.error("Error checking username validity:",error),!1}}document.addEventListener("DOMContentLoaded",(()=>{document.querySelectorAll(".user-search-input").forEach((searchInput=>{if(searchInput&&!searchInput.dataset.initialized){searchInput.dataset.initialized="true";const resultsContainer=searchInput.nextElementSibling;resultsContainer&&resultsContainer.classList.contains("dropdown")&&handleUserSearch(searchInput,resultsContainer)}}))}));